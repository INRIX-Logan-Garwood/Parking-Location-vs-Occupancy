SELECT 
    trip_id,
    provider_id,
    start_lat,
    start_lon,
    end_lat,
    end_lon,
    trip_mean_speed,
    trip_max_speed,
    trip_distance_m,
    MIN(p.capture_time) AS entry_time,
    MAX(p.capture_time) AS stop_time
FROM inrixdatascience.tripdata_na_restricted t
CROSS JOIN UNNEST(points) AS t(p)
WHERE year = '2023'
AND month = '01'
AND day in ('01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23')
AND qk in ('02301')
AND is_moving = 1
AND (
    ST_Intersects(ST_Point(p.lon, p.lat), ST_Polygon('POLYGON ((-118.49897 34.0173, -118.49851 34.01689, -118.49886 34.0166, -118.49932 34.01699, -118.49897 34.0173, -118.49897 34.0173))'))
    OR ST_Intersects(ST_Point(p.lon, p.lat), ST_Polygon('POLYGON ((-118.49437 34.01562, -118.49391 34.01521, -118.49427 34.01491, -118.49474 34.01531, -118.49437 34.01562))'))
    OR ST_Intersects(ST_Point(p.lon, p.lat), ST_Polygon('POLYGON ((-118.49319 34.01457, -118.49407 34.01391, -118.49438 34.01417, -118.49442 34.01427, -118.49361 34.01492, -118.49319 34.01457))'))
    OR ST_Intersects(ST_Point(p.lon, p.lat), ST_Polygon('POLYGON ((-118.49556 34.0143, -118.49553 34.01427, -118.49584 34.01402, -118.49629 34.01442, -118.49595 34.01469, -118.49553 34.01432, -118.49556 34.0143))'))
    OR ST_Intersects(ST_Point(p.lon, p.lat), ST_Polygon('POLYGON ((-118.49785 34.01857, -118.49738 34.01817, -118.49774 34.01788, -118.4982 34.01828, -118.49785 34.01857))'))
    OR ST_Intersects(ST_Point(p.lon, p.lat), ST_Polygon('POLYGON ((-118.49786 34.01636, -118.4974 34.01595, -118.49777 34.01565, -118.49822 34.01604, -118.49786 34.01636))'))
    OR ST_Intersects(ST_Point(p.lon, p.lat), ST_Polygon('POLYGON ((-118.48688 34.00166, -118.48727 34.00143, -118.48823 34.00245, -118.48833 34.0024, -118.48846 34.00261, -118.48824 34.00274, -118.48834 34.00283, -118.48849 34.00273, -118.48854 34.00272, -118.48856 34.00276, -118.4887 34.00271, -118.49134 34.00539, -118.491 34.00562, -118.49033 34.00499, -118.4906 34.00482, -118.49046 34.00467, -118.48988 34.00504, -118.48796 34.00315, -118.4882 34.00299, -118.48807 34.00286, -118.48791 34.00295, -118.48748 34.00249, -118.48759 34.00241, -118.48688 34.00166))'))
    OR ST_Intersects(ST_Point(p.lon, p.lat), ST_Polygon('POLYGON ((-118.49394 34.01238, -118.49435 34.01273, -118.49343 34.01348, -118.49315 34.01324, -118.49321 34.01319, -118.4932 34.01318, -118.49324 34.01315, -118.49327 34.01317, -118.49332 34.01313, -118.49317 34.013, -118.49394 34.01238))'))
    OR ST_Intersects(ST_Point(p.lon, p.lat), ST_Polygon('POLYGON ((-118.49672 34.0103, -118.49659 34.01017, -118.49707 34.01003, -118.49708 34.01007, -118.49727 34.01008, -118.49745 34.01011, -118.49747 34.01006, -118.49804 34.01027, -118.49836 34.01043, -118.49864 34.01059, -118.49868 34.01067, -118.49868 34.01079, -118.49863 34.01088, -118.49735 34.01184, -118.49838 34.01279, -118.49814 34.01296, -118.49637 34.01136, -118.49664 34.01116, -118.49727 34.01175, -118.49733 34.01171, -118.49623 34.01068, -118.49672 34.0103, -118.49672 34.0103))'))
    OR ST_Intersects(ST_Point(p.lon, p.lat), ST_Polygon('POLYGON ((-118.50327 34.01726, -118.50357 34.01751, -118.50359 34.01758, -118.50349 34.01757, -118.50227 34.0166, -118.5018 34.01623, -118.50102 34.01559, -118.50046 34.0151, -118.50071 34.0149, -118.50106 34.0152, -118.50111 34.01523, -118.5011 34.01529, -118.50135 34.01552, -118.50132 34.01555, -118.5014 34.01562, -118.50144 34.01559, -118.50156 34.01569, -118.50159 34.01567, -118.50164 34.01572, -118.50169 34.01569, -118.50342 34.01714, -118.50327 34.01726, -118.50327 34.01726))'))
    OR ST_Intersects(ST_Point(p.lon, p.lat), ST_Polygon('POLYGON ((-118.50774 34.0209, -118.50815 34.02053, -118.50905 34.02126, -118.50863 34.02161, -118.50821 34.02128, -118.50832 34.02118, -118.50814 34.02104, -118.50803 34.02114, -118.50774 34.0209))'))
    OR ST_Intersects(ST_Point(p.lon, p.lat), ST_Polygon('POLYGON ((-118.49577 34.00993, -118.49578 34.00986, -118.49569 34.00978, -118.49586 34.00964, -118.49583 34.00959, -118.49693 34.00872, -118.49717 34.00892, -118.49715 34.00909, -118.49648 34.00962, -118.49643 34.00957, -118.49614 34.00981, -118.4962 34.00986, -118.49594 34.01007, -118.49577 34.00993))'))
    OR ST_Intersects(ST_Point(p.lon, p.lat), ST_Polygon('POLYGON ((-118.49942 34.01983, -118.49933 34.01966, -118.49946 34.01962, -118.49928 34.01947, -118.49915 34.01961, -118.49898 34.01947, -118.49928 34.01922, -118.49988 34.01971, -118.49956 34.01997, -118.49942 34.01983))'))
    OR ST_Intersects(ST_Point(p.lon, p.lat), ST_Polygon('POLYGON ((-118.48544 34.00002, -118.48555 34.00015, -118.48544 34.00022, -118.48341 33.99807, -118.48415 33.99759, -118.48607 33.99962, -118.48544 34.00002))'))
    )
GROUP BY 
    trip_id,
    provider_id,
    start_lat,
    start_lon,
    end_lat,
    end_lon,
    trip_mean_speed,
    trip_max_speed,
    trip_distance_m