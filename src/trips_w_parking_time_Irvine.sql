SELECT 
    trip_id,
    provider_id,
    start_lat,
    start_lon,
    end_lat,
    end_lon,
    trip_mean_speed,
    trip_max_speed,
    trip_distance_m,
    MIN(p.capture_time) AS entry_time,
    MAX(p.capture_time) AS stop_time
FROM inrixdatascience.tripdata_na_restricted t
CROSS JOIN UNNEST(points) AS t(p)
WHERE year = '2023'
AND month = '01'
AND day in ('01', '02', '03', '04')
AND qk in ('02301')
AND is_moving = 1
AND (
    ST_Intersects(ST_Point(p.lon, p.lat), ST_Polygon('POLYGON ((-117.74335 33.64835, -117.74201 33.64802, -117.74189 33.64775, -117.74197 33.64754, -117.74293 33.64777, -117.74348 33.64798, -117.74335 33.64835))'))
    OR ST_Intersects(ST_Point(p.lon, p.lat), ST_Polygon('POLYGON ((-117.74027 33.64827, -117.74028 33.64845, -117.74009 33.64866, -117.7403 33.649, -117.74028 33.64905, -117.74004 33.64915, -117.73997 33.64913, -117.73971 33.64874, -117.73942 33.64838, -117.73941 33.64832, -117.73978 33.64793, -117.74026 33.64823, -117.74027 33.64827))'))
    OR ST_Intersects(ST_Point(p.lon, p.lat), ST_Polygon('POLYGON ((-117.744053131 33.649582084, -117.743578045 33.64898588, -117.743530436 33.648838861, -117.743512666 33.648745235, -117.74359791 33.648463268, -117.743646357 33.648303174, -117.744052125 33.64808692, -117.744087748 33.648132183, -117.744403076 33.648531832, -117.74444926 33.648505261, -117.744755367 33.648887392, -117.744695017 33.648917232, -117.744765006 33.64900256, -117.744640451 33.649062323, -117.744720415 33.649152763, -117.74463802 33.649189392, -117.744668028 33.64922116, -117.744187409 33.649503127, -117.744053131 33.649582084))'))
    OR ST_Intersects(ST_Point(p.lon, p.lat), ST_Polygon('POLYGON ((-117.741726902 33.650923943, -117.741964948 33.651207335, -117.742172064 33.651495757, -117.742280023 33.651673453, -117.741898647 33.65190077, -117.741402354 33.651241953, -117.741309231 33.65111329, -117.74081143 33.650444498, -117.741493382 33.650107546, -117.7417554 33.650406361, -117.741755652 33.650518091, -117.741717262 33.650822774, -117.741726902 33.650923943))'))
    OR ST_Intersects(ST_Point(p.lon, p.lat), ST_Polygon('POLYGON ((-117.743790442 33.653241372, -117.743142354 33.652437883, -117.742597362 33.651762385, -117.743015032 33.651530877, -117.743125674 33.651469521, -117.743111843 33.651452338, -117.743218377 33.651393246, -117.743232124 33.651410596, -117.74324763 33.651401963, -117.743353913 33.65153314, -117.743400516 33.651506234, -117.74427433 33.652584147, -117.744355466 33.652538549, -117.744403076 33.65259739, -117.744321939 33.65264282, -117.744487314 33.652846836, -117.74424097 33.652988993, -117.743790442 33.653241372))'))
    OR ST_Intersects(ST_Point(p.lon, p.lat), ST_Polygon('POLYGON ((-117.739180228 33.648147941, -117.738732383 33.647853317, -117.73856617 33.647640249, -117.738559464 33.647603788, -117.738607744 33.647556765, -117.738425354 33.647440676, -117.739099678 33.646730645, -117.739913561 33.647295166, -117.739896043 33.647307487, -117.739916243 33.647324167, -117.739899228 33.647337746, -117.739920601 33.647355599, -117.739903251 33.64737119, -117.739916662 33.647382338, -117.739531765 33.647779891, -117.739567975 33.64780269, -117.739252731 33.648145929, -117.739215264 33.648116928, -117.739180228 33.648147941))'))
    )
GROUP BY 
    trip_id,
    provider_id,
    start_lat,
    start_lon,
    end_lat,
    end_lon,
    trip_mean_speed,
    trip_max_speed,
    trip_distance_m